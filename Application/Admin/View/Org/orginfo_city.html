<extend name="Base:base"/>
<block name="css_link">
    <link href="__PUBLIC__/assets/css/dataTables.bootstrap.css" rel="stylesheet" />
    <style>
        .table-toolbar{
            position:absolute;
            padding:0;
            z-index: 99;
        }
        .user-list{
            table-layout:fixed ;
        }
        .table>tbody>tr>td.details{
            padding: 0;
        }
        a.add{
            display: none;
        }
        .dataTable .details td, .dataTable .details th{
            padding: 8px;
            border-left:1px solid #ddd;
        }
        @media (min-width: 768px){
            .modal-dialog {
                width: 400px;
                margin: 30px auto;
            }
        }
        @media (max-width: 768px){
            .modal-dialog {
                width: 80%;
                margin: 30px auto;
            }
        }
        .dd2-handle{
            width: 70px;
        }
        .dd2-handle+.dd2-content{
            padding-left: 80px;
        }

    </style>
</block>
<block name="main">
    <div class="row">
        <div class="col-xs-12 col-md-12">
            <div class="widget">
                <div class="widget-header ">
                    <span class="widget-caption">市教育局</span>
                    <div class="widget-buttons">
                        <a href="#" data-toggle="maximize">
                            <i class="fa fa-expand"></i>
                        </a>
                        <a href="#" data-toggle="collapse">
                            <i class="fa fa-minus"></i>
                        </a>
                    </div>
                </div>
                <div class="widget-body">
                    <table class="table table-striped table-hover table-bordered" id="city-table">
                        <thead>
                        <tr>
                            <th>
                                名称
                            </th>
                            <th>
                                账号
                            </th>
                            <th>
                                操作
                            </th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr data-id="{$city.id}">
                            <td>
                                {$city.name}
                            </td>
                            <td>
                                {$city.account }
                            </td>
                            <td>
                                <a href="#" class="btn btn-info btn-xs edit"><i class="fa fa-edit"></i> 编辑</a>
                                <a href="#" class="btn btn-warning btn-xs pass"><i class="fa fa-edit"></i> 重置密码</a>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-xs-12 col-md-12">
            <div class="widget">
                <div class="widget-header ">
                    <span class="widget-caption">区教育局</span>
                    <div class="widget-buttons">
                        <a href="#" data-toggle="maximize">
                            <i class="fa fa-expand"></i>
                        </a>
                        <a href="#" data-toggle="collapse">
                            <i class="fa fa-minus"></i>
                        </a>
                    </div>
                </div>
                <div class="widget-body">
                    <div class="table-toolbar">
                        <a id="editabledatatable_new" href="javascript:void(0);" class="btn btn-default">
                            添加机构
                        </a>
                    </div>
                    <table class="table table-striped table-hover table-bordered" id="editabledatatable">
                        <thead>
                        <tr>
                            <th>
                                名称
                            </th>
                            <th>
                                操作
                            </th>
                        </tr>
                        </thead>
                        <tbody>
                        <volist name="area_list" id="vo">
                            <tr data-id="{$vo.id}">
                                <td>
                                    {$vo.name}
                                </td>
                                <td>
                                    <a href="#" class="btn btn-info btn-xs edit"><i class="fa fa-edit"></i> 编辑</a>
                                    <a href="#" class="btn btn-danger btn-xs delete"><i class="fa fa-trash-o"></i> 删除</a>
                                    <a href="#" class="btn btn-success btn-xs detail"><i class="fa fa-info"></i> 详情</a>
                                    <a href="#" class="btn btn-success btn-xs add"><i class="fa fa-edit"></i> 添加账号</a>
                                </td>
                            </tr>
                        </volist>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-xs-12 col-md-12">
            <div class="widget">
                <div class="widget-header ">
                    <span class="widget-caption">小学</span>
                    <div class="widget-buttons">
                        <a href="#" data-toggle="maximize">
                            <i class="fa fa-expand"></i>
                        </a>
                        <a href="#" data-toggle="collapse">
                            <i class="fa fa-minus"></i>
                        </a>
                    </div>
                </div>
                <div class="widget-body">
                    <div class="table-toolbar">
                        <a id="primary-table-new" for="primary-table" href="javascript:void(0);" class="btn btn-default simple-table-new">
                            添加小学
                        </a>
                    </div>
                    <table class="table table-striped table-hover table-bordered simple-table" id="primary-table">
                        <thead>
                        <tr>
                            <th>
                                名称
                            </th>
                            <th>
                                区属/市属
                            </th>
                            <th>
                                账号
                            </th>
                            <th>
                                毕业班级数
                            </th>
                            <th>
                                操作
                            </th>
                        </tr>
                        </thead>
                        <tbody>
                        <volist name="primary_list" id="vo">
                            <tr data-id="{$vo.id}">
                                <td>
                                    {$vo.name}
                                </td>
                                <td>
                                    {$vo.area}
                                </td>
                                <td>
                                    {$vo.account}
                                </td>
                                <td>
                                    {$vo.class_num}
                                </td>
                                <td>
                                    <a href="#" class="btn btn-info btn-xs edit"><i class="fa fa-edit"></i> 编辑</a>
                                    <a href="#" class="btn btn-danger btn-xs delete"><i class="fa fa-trash-o"></i> 删除</a>
                                    <a href="#" class="btn btn-success btn-xs detail"><i class="fa fa-info"></i> 详情</a>
                                    <a href="#" class="btn btn-warning btn-xs pass"><i class="fa fa-trash-o"></i> 重置密码</a>
                                </td>
                            </tr>
                        </volist>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-xs-12 col-md-12">
            <div class="widget">
                <div class="widget-header ">
                    <span class="widget-caption">初中</span>
                    <div class="widget-buttons">
                        <a href="#" data-toggle="maximize">
                            <i class="fa fa-expand"></i>
                        </a>
                        <a href="#" data-toggle="collapse">
                            <i class="fa fa-minus"></i>
                        </a>
                    </div>
                </div>
                <div class="widget-body">
                    <div class="table-toolbar">
                        <a id="junior-table-new" href="javascript:void(0);" class="btn btn-default">
                            添加初中
                        </a>
                    </div>
                    <table class="table table-striped table-hover table-bordered simple-table" id="junior-table">
                        <thead>
                        <tr>
                            <th>
                                名称
                            </th>
                            <th>
                                区属/市属
                            </th>
                            <th>
                                民办/公办
                            </th>
                            <th>
                                账号
                            </th>
                            <th>
                                操作
                            </th>
                        </tr>
                        </thead>
                        <tbody>
                        <volist name="junior_list" id="vo">
                            <tr data-id="{$vo.id}">
                                <td>
                                    {$vo.name}
                                </td>
                                <td>
                                    {$vo.area}
                                </td>
                                <td>
                                    <if condition="$vo.rank eq 3 ">公办
                                        <else /> 民办
                                    </if>
                                </td>
                                <td>
                                    {$vo.account}
                                </td>
                                <td>
                                    <a href="#" class="btn btn-info btn-xs edit"><i class="fa fa-edit"></i> 编辑</a>
                                    <a href="#" class="btn btn-danger btn-xs delete"><i class="fa fa-trash-o"></i> 删除</a>
                                    <a href="#" class="btn btn-success btn-xs detail"><i class="fa fa-info"></i> 详情</a>
                                    <a href="#" class="btn btn-warning btn-xs pass"><i class="fa fa-trash-o"></i> 重置密码</a>
                                </td>
                            </tr>
                        </volist>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <include file="User:repass"/>


    <!--Hidden Input-->
    <input type="hidden" id="get-area-account-url" value="{:U('User/get_area_account')}" >
    <input type="hidden" id="new-area-url" value="{:U('Org/insert_area')}" >
    <input type="hidden" id="edit-area-url" value="{:U('Org/update_area')}" >
    <input type="hidden" id="del-area-url" value="{:U('Org/delete_area')}" >
    <input type="hidden" id="new-area-account-url" value="{:U('User/insert_user')}" >
    <input type="hidden" id="edit-area-account-url" value="{:U('User/update_user')}" >
    <input type="hidden" id="del-area-account-url" value="{:U('User/delete_user')}" >
    <input type="hidden" id="new-org-url" value="{:U('Org/insert_org')}" >
    <input type="hidden" id="edit-org-url" value="{:U('Org/update_org')}" >
    <input type="hidden" id="del-org-url" value="{:U('Org/delete_org')}" >
    <!--End Hidden Input-->
</block>
<block name="js_link">
    <script src="__PUBLIC__/assets/js/datatable/jquery.dataTables.min.js"></script>
    <script src="__PUBLIC__/assets/js/datatable/ZeroClipboard.js"></script>
    <script src="__PUBLIC__/assets/js/datatable/dataTables.tableTools.min.js"></script>
    <script src="__PUBLIC__/assets/js/datatable/dataTables.bootstrap.min.js"></script>
    <script src="__PUBLIC__/assets/js/datatable/datatables-init.js"></script>
    <script src="__PUBLIC__/assets/js/bootbox/bootbox.js"></script>
    <script>
        var InitiateCityTable = function (){
            return {
                init : function(){
                    var edit_node = '<a href="#" class="btn btn-success btn-xs save"><i class="fa fa-save"></i> 保存</a> <a href="#" class="btn btn-warning btn-xs cancel"><i class="fa fa-times"></i> 关闭</a>';
                    var cityTable = $('#city-table');
                    var tr = cityTable.find('tbody tr')[0];

                    cityTable.on('click', 'a.edit', function(){
                        var tds = $('>td', tr);
                        var tdata = [];
                        for(var i = 0; i < tds.length; i ++){
                            tdata.push( L_trim(tds[i].innerHTML) );
                        }
                        $(tr).data('tdata', tdata);
                        tds[0].innerHTML = '<input type="text" class="form-control input-small" value="' + tdata[0] + '">';
                        tds[1].innerHTML = '<input type="text" class="form-control input-small" value="' + tdata[1] + '">';
                        tds[2].innerHTML =  edit_node ;
                    });

                    cityTable.on('click', 'a.save', function(){
                        var inputs = $('input', tr);
                        var tds = $('>td',tr);
                        var tdata = $(tr).data('tdata');
                        var pdata = {id:$(tr).data('id'),update:{}};
                        var flag = false;

                        if(tdata[0] != inputs[0].value){
                            pdata.update.name =  inputs[0].value;
                            flag = true;
                        }
                        if(tdata[1] != inputs[1].value){
                            pdata.update.account =  inputs[1].value;
                            flag = true
                        }
                        if(flag){
                            do_post(pdata, function(){
                                tds[0].innerHTML = inputs[0].value;
                                tds[1].innerHTML = inputs[1].value;
                                tds[2].innerHTML = $(tr).data('tdata')[2];
                                $(tr).data('tdata', null);
                            });
                        }
                    });

                    cityTable.on('click', 'a.cancel', function(){
                        var tds = $('>td', tr);
                        var tdata = $(tr).data('tdata');
                        for(var i = 0; i < tds.length; i ++){
                            tds[i].innerHTML = tdata[i];
                        }
                    });

                    function do_post(pdata, suCall, errCall){
                        function succ(){
                            alert_info('success', '成功', '操作成功');
                        }
                        function error(msg){
                            alert_info('warning', '失败', msg ? msg : '操作失败');
                        }
                        changeOrg(pdata,function(){
                            succ();
                            if(suCall)  suCall();
                        },function(msg){
                            error(msg);
                            if(errCall) errCall
                        })
                    }

                    cityTable.on("click", 'a.pass', function (e) {
                        e.preventDefault();
                        var tds = $('>td', tr);
                        changePasswd( L_trim(tds[1].innerHTML) );
                    });
                }
            }
        }();
        var InitiateEditableDataTable = function () {
            return {
                init: function () {

                    var ext_node = '<i class="fa fa-plus-square-o row-details"></i>';

                    /*
                     * Insert a 'details' column to the table
                     */
                    var nCloneTh = document.createElement('th');
                    nCloneTh.className = 'ext-td';
                    var nCloneTd = document.createElement('td');
                    nCloneTd.innerHTML = ext_node;
                    nCloneTd.className = 'ext-td';

                    $('#editabledatatable thead tr').each(function () {
                        this.insertBefore(nCloneTh, this.childNodes[0]);
                    });

                    $('#editabledatatable tbody tr').each(function () {
                        this.insertBefore(nCloneTd.cloneNode(true), this.childNodes[0]);
                    });


                    //Datatable Initiating
                    var oTable = $('#editabledatatable').dataTable({
                        "lengthChange": false,
                        "paging": false,
                        "sPaginationType": "bootstrap",
                        "sDom": "Tflt<'row DTTTFooter'<'col-sm-6'i><'col-sm-6'p>>",
                        "oTableTools": {
                            "aButtons": [
                                // "create"
                            ],
                            "sSwfPath": "assets/swf/copy_csv_xls_pdf.swf"
                        },
                        "language": {
                            "search": "",
                            "sLengthMenu": "_MENU_",
                            "oPaginate": {
                                "sPrevious": "<",
                                "sNext": ">"
                            },
                            "zeroRecords": "没有找到符合条件的记录"
                        },
                        "aoColumns": [
                            { "bSortable": false },
                            null,
                            { "bSortable": false }
                        ],
                        "aaSorting" : [],
                        "infoCallback": function( settings, start, end, max, total, pre ) {
                            if(total == 0){
                                start = 0;
                            }
                            return '第 ' + start +" 到 "+ end + ' 行   共' + total + '行';
                        }
                    });

                    var isEditing = null;
                    var isCreating= null;

                    var new_node = '<a href="#" class="btn btn-success btn-xs save"  data-mode="new"><i class="fa fa-save"></i> 保存</a> <a href="#" class="btn btn-warning btn-xs cancel" data-mode="new"><i class="fa fa-times"></i> 关闭</a>';
                    var edit_node = '<a href="#" class="btn btn-success btn-xs save"><i class="fa fa-save"></i> 保存</a> <a href="#" class="btn btn-warning btn-xs cancel"><i class="fa fa-times"></i> 关闭</a>';
                    var opera_node= '<a href="#" class="btn btn-info btn-xs edit"><i class="fa fa-edit"></i> 编辑</a> <a href="#" class="btn btn-danger btn-xs delete"><i class="fa fa-trash-o"></i> 删除</a> <a href="#" class="btn btn-success btn-xs detail"><i class="fa fa-info"></i> 详情</a> <a href="#" class="btn btn-success btn-xs add"><i class="fa fa-edit"></i> 添加账号</a>';

                    //Add New Row
                    $('#editabledatatable_new').click(function (e) {
                        e.preventDefault();
                        if(isCreating != null){
                            return;
                        }
                        var aiNew = oTable.fnAddData(['','',opera_node]);
                        var nRow = oTable.fnGetNodes(aiNew[0]);
                        editRow(oTable, nRow, true);
                        isCreating = nRow;
                    });

                    //Edit A Row
                    $('#editabledatatable').on("click", 'a.edit', function (e) {
                        e.preventDefault();

                        var nRow = $(this).parents('tr')[0];

                        if(isCreating !== null && isCreating != nRow){
                            oTable.fnDeleteRow(isCreating);
                            isCreating = null;
                        }else if (isEditing !== null && isEditing != nRow) {
                            restoreRow(oTable, isEditing);
                        }

                        editRow(oTable, nRow);
                        isEditing = nRow;
                    });

                    //Save an Editing Row
                    $('#editabledatatable').on("click", 'a.save', function (e) {
                        e.preventDefault();
                        if ($(this).attr("data-mode") == "new") {
                            saveRow(oTable, isCreating, true);
                            isCreating= null;
                        }else{
                            saveRow(oTable, isEditing);
                            isEditing = null;
                        }
                        //Some Code to Highlight Updated Row
                    });

                    //Delete an Existing Row
                    $('#editabledatatable').on("click", 'a.delete', function (e) {
                        e.preventDefault();

                        var nRow = $(this).parents('tr')[0];
                        var aData = oTable.fnGetData(nRow);

                        bootbox.confirm('确定删除 "'+aData[1]+'" 吗? ', function (result) {
                            if (result) {
                                changeArea($(nRow).data('id'), '', function(){
                                    oTable.fnDeleteRow(nRow);
                                    $('#modal-success').modal('show');
                                },function(info){
                                    alert_info('warning', '错误', info);
                                })
                            }
                        });
                    });

                    //Cancel Editing or Adding a Row
                    $('#editabledatatable').on("click", 'a.cancel', function (e) {
                        e.preventDefault();
                        if ($(this).attr("data-mode") == "new") {
                            restoreRow(oTable, isCreating, true);
                            isCreating = null;
                        } else {
                            restoreRow(oTable, isEditing);
                            isEditing = null;
                        }
                    });

                    /**
                     * 恢复一行
                     * @param oTable datatables 对象
                     * @param nRow 要恢复的行
                     **/
                    function restoreRow(oTable, nRow, isnew) {
                        if(isnew){
                            return oTable.fnDeleteRow(nRow);
                        }
                        var aData = oTable.fnGetData(nRow);
                        var jqTds = $('>td', nRow);

                        for (var i = 0, iLen = jqTds.length; i < iLen; i++) {
                            oTable.fnUpdate(aData[i], nRow, i, false);
                        }

                        oTable.fnDraw();
                    }

                    /**
                     * 编辑一行
                     * @param oTable datatables 对象
                     * @param nRow 要编辑的行
                     * @param isnew 是否为新添行
                     **/
                    function editRow(oTable, nRow, isnew) {
                        var aData = oTable.fnGetData(nRow);
                        var jqTds = $('>td', nRow);
                        jqTds[0].innerHTML = '';
                        jqTds[1].innerHTML = '<input type="text" class="form-control input-small" value="' + aData[1] + '">';
                        if(isnew){
                            jqTds[2].innerHTML = new_node;
                        }else{
                            jqTds[2].innerHTML = edit_node;
                        }
                    }

                    /**
                     * 保存一行的更改
                     * @param oTable datatables 对象
                     * @param nRow 要编辑的行
                     * @param isnew 是否为新添行
                     **/
                    function saveRow(oTable, nRow, isnew) {
                        var jqInputs = $('input', nRow);
                        var name = jqInputs[0].value;
                        if('' == name || typeof name == 'undefined'){
                            return restoreRow(oTable, nRow);
                        }
                        function update(){
                            oTable.fnUpdate(name, nRow, 1, false);
                            oTable.fnUpdate(opera_node, nRow, 2, false);
                            oTable.fnDraw();
                        }
                        function error(info){
                            restoreRow(oTable, nRow);
                            alert_info('warning', '错误', info);
                        }
                        if(isnew){
                            changeArea('', name, function(){
                                oTable.fnUpdate(ext_node, nRow, 0, false);
                                $(nRow).data('list',[]);
                                update()
                            },error)
                        }else{
                            changeArea($(nRow).data('id'), name,function(){
                                update();
                            },error)
                        }

                    }

                    /**
                     * post提交改变一区的数据
                     * @param id 区 id
                     * @param name 区名
                     * @suCall 成功回调函数
                     * @errCall 失败回调函数
                     **/
                    function changeArea(id, name, suCall, errCall){
                        if(!id) { // 添加
                            var url = $('#new-area-url').val();
                            var data = {name:name};
                        } else if(name) { // 编辑
                            var url = $('#edit-area-url').val();
                            var data = {id:id, name:name};
                        } else { //删除
                            var url = $('#del-area-url').val();
                            var data = {id:id};
                        }

                        $.post(url, data, function(data){
                            if(data.code == 0){
                                suCall(data.data);
                            }else{
                                if(errCall) errCall(data.msg);
                            }
                        });
                    }

                    $('#editabledatatable').on('click', ' tbody td .row-details', function () {
                        var nTr = $(this).parents('tr')[0];
                        if(isEditing != null && isEditing != nTr){
                            restoreRow(oTable, isEditing);
                        }
                        if(isCreating != null && isCreating != nTr){
                            restoreRow(oTable, isCreating, true);
                        }

                        if (oTable.fnIsOpen(nTr)) {
                            /* This row is already open - close it */
                            $(this).addClass("fa-plus-square-o").removeClass("fa-minus-square-o");
                            oTable.fnClose(nTr);
                            $(nTr).find('.add').hide();
                        }
                        else {
                            /* Open this row */
                            $(this).addClass("fa-minus-square-o").removeClass("fa-plus-square-o");
                            list = $(nTr).data('list');
                            if(!list || list.length < 1){
                                //加载 区教育局的账号, 并保存
                                var url = $('#get-area-account-url').val();
                                $.post(url, {id: $(nTr).data('id')}, function(data){
                                    if(data.code == 0){
                                        $(nTr).data('list',data.data);
                                        ext();
                                    }else{
                                        alert_info('warning', '错误', '加载失败');
                                    }
                                })
                            }else{
                                ext();
                            }
                        }
                        function ext(){
                            oTable.fnOpen(nTr, fnFormatDetails(nTr), 'details');
                            $(nTr).find('.add').show();

                            $(window).resize(function(){
                                $(nTr).next().find('.user-list').css('margin-left',  $('.ext-td ')[0].offsetWidth-1 + 'px')
                                        .find('tbody td:first-child,thead th:first-child').css('width', $('.ext-td ').next()[0].offsetWidth + 'px');
                            }).resize();
                        }
                    });

                    var child_new_node = '<a href="#" class="btn btn-success btn-xs child-save"  data-mode="new"><i class="fa fa-save"></i> 保存</a> <a href="#" class="btn btn-warning btn-xs child-cancel" data-mode="new"><i class="fa fa-times"></i> 关闭</a>';
                    var child_edit_node = '<a href="#" class="btn btn-success btn-xs child-save"><i class="fa fa-save"></i> 保存</a> <a href="#" class="btn btn-warning btn-xs child-cancel"><i class="fa fa-times"></i> 关闭</a>';
                    var child_opera_node= '<a href="#" class="btn btn-info btn-xs child-edit"><i class="fa fa-edit"></i> 编辑</a> <a href="#" class="btn btn-danger btn-xs child-delete"><i class="fa fa-trash-o"></i> 删除</a> <a href="#" class="btn btn-warning btn-xs child-pass"><i class="fa fa-trash-o"></i> 重置密码</a>'

                    var child_isCreating = null;
                    var child_isEditing = null;

                    //Add New Row
                    $('#editabledatatable').on('click', '.add', function(e){
                        e.preventDefault();
                        var aNew = document.createElement('tr');
                        aNew.innerHTML = '<td><input type="text" class="form-control input-small"></td><td>'+ child_new_node +'</td>';
                        $(this).parent().parent().next().find('tbody').prepend(aNew);
                        child_isCreating = aNew;
                    })

                    /* Formatting function for row details */
                    function fnFormatDetails(otr) {
                        var data = $(otr).data('list');
                        if(!data){
                            data = [];
                        }
                        var sOut = '<table class="user-list">';
                        sOut += '<thead>';
                        sOut += '<tr><th>账号</th><th>操作</th></tr>';
                        sOut += '</thead>';
                        sOut += '<tbody>';

                        for(var i = 0; i < data.length; i ++){
                            sOut += '<tr data-id = "'+data[i].id+'">';
                            sOut += '<td>'+data[i].account+'</td>';
                            sOut += '<td>'+child_opera_node+'</td>';
                            sOut += '</tr>';
                        }

                        sOut += '</tbody>';
                        sOut += '</table>';

                        var ctable = $(sOut);

                        ctable.on("click", 'a.child-pass', function (e) {
                            e.preventDefault();
                            var nRow = $(this).parents('tr')[0];
                            var aData = getData($(nRow).attr('data-id'));
                            changePasswd(aData,function(){

                            });
                        });
                        ctable.on("click", 'a.child-pass', function (e) {
                            e.preventDefault();
                            var nRow = $(this).parents('tr')[0];
                            var aData = oTable.fnGetData(nRow);
                            changePasswd(aData[0]);
                        });

                        //Edit A Row
                        ctable.on("click", 'a.child-edit', function (e) {
                            e.preventDefault();

                            var nRow = $(this).parents('tr')[0];

                            if(child_isCreating !== null && child_isCreating != nRow){
                                isCreating.remove();
                                isCreating = null;
                            }else if (child_isEditing !== null && child_isEditing != nRow) {
                                restoreRow(child_isEditing);
                            }
                            editRow(nRow);
                            child_isEditing = nRow;
                        });

                        //Save an Editing Row
                        ctable.on("click", 'a.child-save', function (e) {
                            e.preventDefault();
                            if ($(this).attr("data-mode") == "new") {
                                saveRow(child_isCreating, true);
                                child_isCreating= null;
                            }else{
                                saveRow(child_isEditing);
                                child_isEditing = null;
                            }
                            //Some Code to Highlight Updated Row
                        });

                        //Delete an Existing Row
                        ctable.on("click", 'a.child-delete', function (e) {
                            e.preventDefault();

                            var nRow = $(this).parents('tr')[0];
                            var aData = getData($(nRow).attr('data-id'));
                            bootbox.confirm('确定删除 "'+aData+'" 吗? ', function (result) {
                                if (result) {
                                    changeAccount($(nRow).attr('data-id'), '', function(){
                                        nRow.remove();
                                    })
                                }
                            });
                        });

                        //Cancel Editing or Adding a Row
                        ctable.on("click", 'a.child-cancel', function (e) {
                            e.preventDefault();
                            if ($(this).attr("data-mode") == "new") {
                                var nRow = $(this).parents('tr')[0];
                                nRow.remove();
                                child_isCreating = null;
                            } else {
                                restoreRow(child_isEditing);
                                child_isEditing = null;
                            }
                        });

                        function restoreRow(nRow) {
                            var aData = getData($(nRow).attr('data-id'));
                            var jqTds = $('>td', nRow);

                            jqTds[0].innerHTML = aData;
                            jqTds[1].innerHTML = child_opera_node;
                        }

                        function editRow(nRow, isnew) {
                            var jqTds = $('>td', nRow);
                            jqTds[0].innerHTML = '<input type="text" class="form-control input-small" value="' + jqTds[0].innerHTML + '">';
                            if(isnew){
                                jqTds[1].innerHTML = child_new_node;
                            }else{
                                jqTds[1].innerHTML = child_edit_node;
                            }
                        }

                        function saveRow(nRow, isnew) {
                            var jqInputs = $('input', nRow);

                            function addchild(){

                            }

                            if(isnew){
                                changeAccount('', jqInputs[0].value,function(newid){
                                    nRow.children[0].innerHTML =   jqInputs[0].value;
                                    nRow.children[1].innerHTML =   child_opera_node;
                                    $(nRow).attr('data-id',newid);
                                },function(){
                                    nRow.remove();
                                });
                            }else{
                                changeAccount($(nRow).attr('data-id'),  jqInputs[0].value,function(){
                                    nRow.children[0].innerHTML =   jqInputs[0].value;
                                    nRow.children[1].innerHTML =   child_opera_node;
                                },function(){
                                    restoreRow(nRow);
                                });
                            }
                        }

                        function getData(key){
                            for(var i = 0; i < data.length; i ++){
                                if(data[i].id == key){
                                    return data[i].account;
                                }
                            }
                            return false;
                        }

                        function changeAccount(id, name, suCall, errCall){
                            function deleteCall(){
                                for(var i = 0; i < data.length; i ++){
                                    if(data[i].id == id){
                                        data.splice(i,1);
                                        break;
                                    }
                                }
                            }
                            function insertCall(id){
                                var idata = {
                                    id : id,
                                    account : name
                                }
                                data.unshift(idata);
                            }
                            function updateCall(){
                                for(var i = 0; i < data.length; i ++){
                                    if(data[i].id == id){
                                        data[i].account = name;
                                        $(otr).data('list', data);
                                        break;
                                    }
                                }
                            }
                            if(!id) { // 添加
                                var url = $('#new-area-account-url').val();
                                var pdata = {account:name};
                                var fun = insertCall;
                            } else if(name) { // 编辑
                                var url = $('#edit-area-account-url').val();
                                var pdata = {id:id, account:name};
                                var fun = updateCall;
                            } else { //删除
                                var url = $('#del-area-account-url').val();
                                var pdata = {id:id};
                                var fun = deleteCall;
                            }
                            pdata.oid = $(otr).data('id');

                            $.post(url, pdata, function(dd){
                                if(dd.code == 0){
                                    fun(dd.data);
                                    suCall(dd.data);
                                    alert_info('success','成功','操作成功');
                                }else{
                                    if(errCall) errCall(dd.msg);
                                    alert_info('warning','失败',dd.msg);
                                }
                            });
                        }

                        return ctable;
                    }
                }
            };
        }();
        var InitiateSimpleTable = function () {
            return {
                init: function () {
                    var tableElem = $('.simple-table');
                    var oTable = null;
                    //Datatable Initiating
                    var aTable = tableElem.dataTable({
                        "lengthChange": false,
                        "iDisplayLength": 10,
                        "sPaginationType": "bootstrap",
                        "sDom": "Tflt<'row DTTTFooter'<'col-sm-6'i><'col-sm-6'p>>",
                        "oTableTools": {
                            "aButtons": [
                                // "create"
                            ],
                            "sSwfPath": "assets/swf/copy_csv_xls_pdf.swf"
                        },
                        "language": {
                            "search": "",
                            "sLengthMenu": "_MENU_",
                            "oPaginate": {
                                "sPrevious": "<",
                                "sNext": ">"
                            },
                            "zeroRecords": "没有找到符合条件的记录"
                        },
                        "aoColumns": [
                            null,
                            null,
                            null,
                            null,
                            { "bSortable": false }
                        ],
                        "infoCallback": function( settings, start, end, max, total, pre ) {
                            return '第 ' + start +" 到 "+ end + ' 行   共' + total + '行';
                        }
                    });

                    /**
                     * 得到选择区的下拉列表
                     * @param {string} selected 初始选中的
                     * @returns {string} <select>html
                     */
                    function getSelectNode(selected){
                        var select_node = '<select class="form-control" name="area">' ;

                        $('#editabledatatable tbody>tr').each(function(){
                            var tid = $(this).data('id');
                            if(tid > 0){
                                var value = $(this).find('td:nth-child(2)').text();
                                if(value == selected){
                                    select_node += '<option selected value="'+tid+'">';
                                }else{
                                    select_node += '<option value="'+tid+'">';
                                }
                                select_node +=  value + '</option>';
                            }
                        })

                        //select_node +=  value + '</option>';
                        select_node += '</select>';
                        return select_node;
                    }

                    function getRadioNode(select){
                        var radio_node = '<select> class="form-control" name="private">';
                        if(select == '公办'){
                            radio_node += '<option value = "3" selected>公办</option><option value = "4">民办</option>';
                        }else if(select == '公办'){
                            radio_node += '<option value = "3">公办</option><option value = "4" selected>民办</option>';
                        }else{
                            radio_node += '<option value = "3">公办</option><option value = "4">民办</option>';
                        }
                        radio_node += '</select>';
                        return radio_node;
                    }

                    //var new_node = '<a href="#" class="btn btn-success btn-xs save"  data-mode="new"><i class="fa fa-save"></i> 保存</a> <a href="#" class="btn btn-warning btn-xs cancel" data-mode="new"><i class="fa fa-times"></i> 关闭</a>';
                    var edit_node = '<a href="#" class="btn btn-success btn-xs save"><i class="fa fa-save"></i> 保存</a> <a href="#" class="btn btn-warning btn-xs cancel"><i class="fa fa-times"></i> 关闭</a>';
                    var opera_node= '<a href="#" class="btn btn-info btn-xs edit"><i class="fa fa-edit"></i> 编辑</a> <a href="#" class="btn btn-danger btn-xs delete"><i class="fa fa-trash-o"></i> 删除</a> <a href="#" class="btn btn-success btn-xs detail"><i class="fa fa-info"></i> 详情</a> <a href="#" class="btn btn-warning btn-xs pass"><i class="fa fa-edit"></i> 重置密码</a>';
                    function primaryEditData(aData){
                        return ['<input type="text" class="form-control input-small" value="' + aData[0] + '">',
                            getSelectNode(aData[1]),
                            '<input type="text" class="form-control input-small" value="' + aData[2] + '">',
                            aData[3],
                            edit_node]
                    }

                    function juniorEditData(aData){
                        return ['<input type="text" class="form-control input-small" value="' + aData[0] + '">',
                            getSelectNode(aData[1]),
                            getRadioNode(aData[2]),
                            '<input type="text" class="form-control input-small" value="' + aData[3] + '">',
                            edit_node]
                    }

                    function primaryPostData(oTable, nRow, suCall, errCall){
                        var isnew = false;
                        console.log(isCreating(oTable));
                        if(nRow == isCreating(oTable)){
                            isnew = true;
                        }
                        var jqInputs = $('input,select', nRow);
                        var name = jqInputs[0].value;
                        var pid = jqInputs[1].value;
                        var pname = jqInputs.find('option[value='+pid+']').text();
                        var account = jqInputs[2].value;

                        console.log(isnew ? 1111 : 2222);

                        if(isnew){
                            changeOrg({
                                id:'',
                                update:{
                                    name : name,
                                    pid : pid,
                                    rank: 5,
                                    account : account
                                }
                            },suCall,errCall);
                        }else{
                            var aData = oTable.fnGetData(nRow);
                            var update = {};
                            var flag = false;
                            if(name != aData[0]){
                                flag = true;
                                update.name = name;
                            }
                            if(pname != aData[1]){
                                flag = true;
                                update.pid = pid;
                            }
                            if(account != aData[2]){
                                flag = true;
                                update.account = account;
                            }
                            if(flag){
                                changeOrg({
                                    id:$(nRow).data('id'),
                                    update:update
                                },suCall,errCall);
                            }else{
                                errCall();
                            }
                        }
                    }

                    function juniorPostData(oTable, nRow, suCall, errCall){
                        var isnew = false;
                        if(nRow == isCreating(oTable)){
                            isnew = true;
                        }
                        var jqInputs = $('input,select', nRow);
                        var name = jqInputs[0].value;
                        var pid = jqInputs[1].value;
                        var pname = L_trim($(jqInputs[1]).find('option[value='+pid+']').text());
                        var rank = jqInputs[2].value;
                        var rname = L_trim($(jqInputs[2]).find('option[value='+rank+']').text());
                        var account = jqInputs[3].value;

                        if(isnew){
                            changeOrg({
                                id:'',
                                update:{
                                    name : name,
                                    pid : pid,
                                    rank: rank,
                                    account : account
                                }
                            },suCall,errCall);
                        }else{
                            var aData = oTable.fnGetData(nRow);
                            var update = {};
                            var flag = false;
                            if(name != aData[0]){
                                flag = true;
                                update.name = name;
                            }
                            console.log(pname +':'+ aData[1]);
                            if(pname != aData[1]){
                                flag = true;
                                update.pid = pid;
                            }
                            if(rname != aData[2]){
                                flag = true;
                                update.rank = rank;
                            }
                            if(account != aData[3]){
                                flag = true;
                                update.account = account;
                            }
                            if(flag){
                                changeOrg({
                                    id:$(nRow).data('id'),
                                    update:update
                                },suCall,errCall);
                            }else{
                                errCall();
                            }
                        }
                    }

                    tableElem.on("click", 'a', function (e) {
                        var fTable = $(this).parents('table');
                        oTable = fTable.dataTable();
                    });

                    tableElem.on("click", 'a.pass', function (e) {
                        e.preventDefault();
                        var nRow = $(this).parents('tr')[0];
                        var aData = oTable.fnGetData(nRow);
                        if(oTable.is('#junior-table')){
                            changePasswd(aData[3]);
                        }else{
                            changePasswd(aData[2]);
                        }
                    });

                    //Add New Row
                    $('#primary-table-new').click(function(e){
                        e.preventDefault();
                        oTable = $('#primary-table').dataTable();
                        if(isCreating(oTable)){
                            return;
                        }
                        var nRow = addRow(oTable,['','','',0,opera_node]);
                        $(nRow).data('mode','new');
                        editRow(oTable, nRow);
                    });

                    $('#junior-table-new').click(function(e){
                        e.preventDefault();
                        oTable = $('#junior-table').dataTable();
                        if(isCreating(oTable)){
                            return;
                        }
                        var nRow = addRow(oTable,['','','','',opera_node]);
                        $(nRow).data('mode','new');
                        editRow(oTable, nRow);
                    });

                    //Edit A Row
                    tableElem.on("click", 'a.edit', function (e) {
                        e.preventDefault();
                        var nRow = $(this).parents('tr')[0];

                        if(isCreating(oTable)){
                            restoreRow(oTable, isCreating(oTable));
                        }
                        if(isEditing(oTable)){
                            restoreRow(oTable, isEditing(oTable));
                        }
                        editRow(oTable, nRow);
                    });

                    //Delete an Existing Row
                    tableElem.on("click", 'a.delete', function (e) {
                        e.preventDefault();

                        var nRow = $(this).parents('tr')[0];
                        var aData = oTable.fnGetData(nRow);

                        bootbox.confirm('确定删除 "'+aData[0]+'" 吗? ', function (result) {
                            if (result) {
                                oTable.fnDeleteRow(nRow);
                            }
                        });
                    });

                    //Save an Editing Row
                    tableElem.on("click", 'a.save', function (e) {
                        e.preventDefault();
                        var nRow = $(this).parents('tr')[0];

                        function succ(){
                            alert_info('success', '成功', '操作成功');
                        }
                        function error(msg){
                            alert_info('warning', '失败', msg ? msg : '操作失败');
                        }

                        if(oTable.is('#primary-table')){
                            primaryPostData(oTable, nRow, function($data){
                                succ()
                                saveRow(oTable, nRow, $data);
                            },error);
                        }else{
                            juniorPostData(oTable, nRow, function($data){
                                succ()
                                saveRow(oTable, nRow, $data);
                            },error);
                        }
                        //Some Code to Highlight Updated Row
                    });

                    //Cancel Editing or Adding a Row
                    tableElem.on("click", 'a.cancel', function (e) {
                        e.preventDefault();
                        var nRow = $(this).parents('tr')[0];
                        restoreRow(oTable, nRow);

                        if ($(this).attr("data-mode") == "new") {
                            isCreating = null;
                        } else {
                            isEditing = null;
                        }
                    });

                    function isCreating(oTable, value){
                        if(typeof value == 'undefined'){
                            return oTable.data('isCreating');
                        }else{
                            return oTable.data('isCreating',value);
                        }
                    }

                    function isEditing(oTable, value){
                        if(typeof value == 'undefined'){
                            return oTable.data('isEditing');
                        }else{
                            return oTable.data('isEditing',value);
                        }
                    }

                    function addRow(oTable, RowData){
                        var aiNew = oTable.fnAddData(RowData);
                        var at = oTable.fnGetNodes(aiNew[0]);
                        $(at).data('mode', 'new');
                        return at;
                    }

                    function editRow(oTable, nRow) {
                        window.kk = nRow;
                        var aData = oTable.fnGetData(nRow);
                        if(oTable.is('#primary-table')){
                            fun = primaryEditData;
                        }else{
                            fun = juniorEditData;
                        }
                        if($(nRow).data('mode') == 'new'){
                            isCreating(oTable, nRow);
                        }else{
                            isEditing(oTable, nRow);
                        }
                        var jqTds = $('>td', nRow);
                        var ndata = fun(aData);
                        jqTds[0].innerHTML = ndata[0];
                        jqTds[1].innerHTML = ndata[1];
                        jqTds[2].innerHTML = ndata[2];
                        jqTds[3].innerHTML = ndata[3];
                        jqTds[4].innerHTML = ndata[4];
                    }

                    function saveRow(oTable, nRow, $rid){

                        var jqInputs = $('input,select', nRow);
                        var showData = [];
                        for(var key = 0; key < jqInputs.length; key ++){
                            if(jqInputs[key].nodeName == "SELECT"){
                                showData[key] = $(jqInputs[key]).find('option[value='+jqInputs[key].value+']').text();
                            }else{
                                showData[key] = jqInputs[key].value;
                            }
                            oTable.fnUpdate(showData[key], nRow, key, false);
                        }
                        oTable.fnUpdate(opera_node, nRow, 4, false);
                        oTable.fnDraw();

                        if(nRow == isCreating(oTable)){
                            isCreating(oTable, null);
                            $(nRow).attr('data-id',$rid);
                        }else if(nRow == isEditing(oTable)){
                            isEditing(oTable, null);
                        }

                    }

                    function restoreRow(oTable, nRow) {
                        if(nRow == isCreating(oTable) ){
                            oTable.fnDeleteRow(nRow);
                        }else{
                            var aData = oTable.fnGetData(nRow);
                            var jqTds = $('>td', nRow);

                            for (var i = 0, iLen = jqTds.length; i < iLen; i++) {
                                oTable.fnUpdate(aData[i], nRow, i, false);
                            }
                        }
                        oTable.fnDraw();
                    }
                }
            };
        }();

        /**
         * post提交改变一个一般机构的数据
         * @param ndata 修改信息{id, update : {name, pid, rank, account} }
         * @suCall 成功回调函数
         * @errCall 失败回调函数
         **/
        function changeOrg(ndata, suCall, errCall){
            console.log(ndata);
            if(typeof ndata != 'object'){
                errCall('数据不合法');
                return false;
            }
            if(!ndata.id && !ndata.update){
                errCall('数据不合法');
                return false;
            }
            if(!ndata.id) { // 添加
                for(var item in ndata.update){
                    if(ndata.update[item] == ''){
                        errCall('数据不合法');
                        return false;
                    }
                }
                var url = $('#new-org-url').val();
                var pdata = ndata.update;
            } else if(ndata.update) { // 编辑
                var pdata = {id:ndata.id};
                for(var item in ndata.update){
                    if(ndata.update[item]){
                        pdata[item] = ndata.update[item];
                    }
                }
                var url = $('#edit-org-url').val();
            } else { //删除
                var url = $('#del-org-url').val();
                var pdata = {id:ndata.id};
            }

            $.post(url, pdata, function(data){
                if(data.code == 0){
                    suCall(data.data);
                }else{
                    if(errCall) errCall(data.msg);
                }
            });
        }

        InitiateCityTable.init();
        InitiateEditableDataTable.init();
        InitiateSimpleTable.init();
    </script>
    <include file="Org:detail"/>
</block>